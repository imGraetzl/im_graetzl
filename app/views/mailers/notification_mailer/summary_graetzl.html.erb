<% content_for(:above_title, "Hey #{@user.first_name},") %>
<% if @period == 'daily' %>
  <% content_for(:title, "Neuigkeiten von Heute") %>
<% elsif @period == 'weekly' %>
  <% content_for(:title, "Neuigkeiten der Woche") %>
<% end %>
<% content_for(:subtitle, "#{t("region.#{@region.id}.from_graetzl")} #{@user.graetzl.name} & #{t("region.#{@region.id}.favorite_graetzls")}") %>

<!-- Prepare Zuckerls for User (Own Zuckerl and Others), max 4 -->
<% current_position = 0 %>
<% zuckerl_position = 3 %>
<% allzuckerls = Zuckerl.in(@region).live.in_area(@user.followed_graetzl_ids).include_for_box %>
<% ownzuckerls = allzuckerls.where(user_id: @user.id) %>
<% zuckerls = (allzuckerls - ownzuckerls).sample(4) %>
<% zuckerls += ownzuckerls %>

<% NotificationMailer::GRAETZL_SUMMARY_BLOCKS.each do |block_title, notification_types| %>
  <% notifications = @notifications.select{|n| n.class.in?(notification_types)} %>
  <% next if notifications.empty? %>
  <% current_position += 1 %>

  <!-- Insert on 3. Position -->
  <%= render 'featured/frauen_des_jahres' if @region.id == 'wien' && @period == 'weekly' && current_position == 2 %>

  <!-- Insert 2 Random Zuckerls on 3. Position -->
  <%= render "summary/new_zuckerl", zuckerls: zuckerls.last(2) if current_position == zuckerl_position && @period == 'weekly' %>
  <%= render "summary/new_zuckerl_footer" if @region.id == 'wien' && @period == 'weekly' && current_position == zuckerl_position %>

  <%= render 'summary/block_header', title: block_title %>
  <% notifications.each do |notification| %>
    <%= render "summary/#{notification.mail_template}", notification: notification %>
  <% end %>
  
  <!-- Hack: Insert Footer Text for RoomOffers in Mails in Vienna -->
  <%= render "summary/#{notifications[0].mail_template}_footer" if notifications[0].type == 'Notifications::NewRoomOffer' && @region.id == 'wien' %>

<% end %>

<% if current_position < zuckerl_position %>
  <!-- Insert 2 Random Zuckerls here if no Zuckerls where inserted above -->
  <%= render "summary/new_zuckerl", zuckerls: zuckerls.last(2) if @period == 'weekly' %>
<% elsif current_position > zuckerl_position && allzuckerls.count >= 6 %>
  <!-- Insert 2 more Random Zuckerls if there are more then 6 available -->
  <%= render "summary/new_zuckerl", zuckerls: zuckerls.first(2) if @period == 'weekly' %>
<% end %>

<!-- Insert Supporters -->
<% if @region.id == 'wien' && @period == 'weekly' %>
  <%= render 'summary/new_admin_discussion' if @featured_discussion %>
  <%= render 'featured/subscribers' if Subscription.in(@region).active.present? %>
<% end %>