<aside class="sideBar">

  <div class="sideBarbox contact">
    <%= link_to content_tag(:h3, @room_offer.graetzl.name, class: 'sideflag -L'), @room_offer.graetzl %>

    <div class="iconlist">
      <% if @room_offer.address %>
        <div class="address icontxt">
          <%= icon_tag "map-location" %>
          <%= @room_offer.address.street %><br>
          <%= "#{@room_offer.address.zip} #{@room_offer.address.city}" %><br>
        </div>
      <% end %>

      <% if @room_offer.rented_area.present? %>
        <div class="rented-area icontxt">
          <%= icon_tag "resize-maximize" %>
          <%= "%g" % (@room_offer.rented_area) %> m² zu vermieten<br>
        </div>
      <% end %>

      <% if @room_offer.wants_collaboration? %>
        <div class="collaboration icontxt">
          <%= icon_tag "urgent-extra-notice-info-announcement" %>
          Auch an Kooperationen interessiert.
        </div>
      <% end %>

      <% if @room_offer.room_offer_prices.present? %>
        <div class="pricing icontxt">
          <ul class="pricing-list">
            <% @room_offer.room_offer_prices.each do |price| %>
              <li>
                <div class="cost"><%= "%g €" % price.amount %></div>
                <div class="costname"><%= price.name %></div>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <% if user_signed_in? && current_user == @room_offer.user %>
        <div class="btn-group">
          <%= link_to 'Gruppe erstellen', new_group_path(room_offer_id: @room_offer.id),
            class: 'btn-secondary -mint -small'  %>
        </div>
      <% end %>

      <% if user_signed_in? && current_user == @room_offer.user %>
        <div class="btn-group">
          <%= link_to 'Bearbeiten', edit_room_offer_path(@room_offer),
            class: 'btn-secondary -mint -small'  %>
        </div>
        <div class="btn-group">
          <%= link_to "javascript:", data: { jq_dropdown: "#room-state-update-dropdown" }, class: "btn-secondary -mint -small -state-#{@room_offer.status}" do %>
            Status: <span><%= t("activerecord.attributes.room_offer.statuses.#{@room_offer.status}") %></span>
          <% end %>
        </div>
        <div id="room-state-update-dropdown" class="jq-dropdown jq-dropdown-tip jq-dropdown-relative jq-dropdown-anchor-right dropdown-container">
          <div class="jq-dropdown-panel">
            <%= link_to 'Aktiv', [:update_status, @room_offer, status: "enabled"], method: :patch %>
            <%= link_to 'Inaktiv', [:update_status, @room_offer, status: "disabled"], method: :patch %>
            <%= link_to 'Voll / Warteliste aktivieren', [:update_status, @room_offer, status: "occupied"], method: :patch %>
            <%= link_to 'Löschen', room_offer_path(@room_offer), data: { confirm: 'Bist du dir sicher?' }, method: :delete %>
          </div>
        </div>
      <% end %>
    </div>

    <% if @room_offer.address.try(:coordinates) %>
      <%= link_to google_map_url(@room_offer.address), class: 'gmap' do %>
        <%= image_tag static_map_url(@room_offer.address.coordinates, zoom: 16, size: [250,150]) %>
      <% end %>
    <% end %>

  </div>

  <% if @room_offer.occupied? %>

    <div class="sideBarbox waiting-list">
      <h3 class='sideflag -L'>Warteliste <%= icon_tag "coffee" %></h3>

      <% if @room_offer.waiting_users.present? %>
      <ul>
        <% @room_offer.waiting_users.each do |user| %>
          <li class="waiting-list-user">
            <%= link_to user do %>
              <%= attachment_image_tag user, :avatar, :fill, 100, 100, fallback: 'avatar/user/100x100.png', class: 'img-round' %>
            <% end %>
            <% if current_user == user || current_user == @room_offer.user %>
              <%= link_to [:remove_from_waitlist, @room_offer, user: user], method: :post, class: 'delete' do %>
                <%= icon_tag "cross" %>
              <% end %>
            <% end %>
          </li>
        <% end %>
      </ul>
      <% else %>
        <div class="wait-list-wrapper">
          <p>Noch niemand auf der Warteliste..</p>
        </div>
      <% end %>

      <div class="wait-list-wrapper">
        <% if user_signed_in? && current_user != @room_offer.user %>
          <% if !@room_offer.waiting_users.include?(current_user) %>
            <%= link_to [:toggle_waitlist, @room_offer], method: :post, class: 'btn-userIcons -mint' do %>
              <span><%= avatar_for current_user %> Auf die Warteliste</span>
            <% end %>
          <% end %>
        <% elsif !user_signed_in? %>
          <%= link_to new_user_session_path(redirect: request.original_url), class: 'btn-userIcons -mint' do %>
            <span><%= image_tag 'avatar/user/default.png', class: 'img-round' %> Auf die Warteliste</span>
          <% end %>
        <% end %>
      </div>

    </div>
  <% end %>

  <% if @room_offer.location %>
    <aside class="location">
      <%= render @room_offer.location %>
    </aside>
  <% end %>

  <% if @room_offer.email.present? && current_user %>
    <%= mail_to @room_offer.email, "Anbieter kontaktieren", class: 'btn-primary -mint -contact', id: 'room-contact-btn', subject: "Raumteiler Kontakt" %>
  <% end %>

  <%= link_to "Alle Raumteiler", rooms_wien_path, class: 'btn-primary -mint' %>

</aside>
